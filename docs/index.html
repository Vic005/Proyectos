import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged
} from 'firebase/auth';
import {
  getFirestore, collection, query, where, onSnapshot,
  addDoc, updateDoc, deleteDoc, doc, setLogLevel, getDocs,
  runTransaction // ¡CRUCIAL para operaciones atómicas como reordenar!
} from 'firebase/firestore';
import {
  PencilIcon, TrashIcon, CheckCircleIcon, PlayIcon, Square, PlusIcon,
  Loader2, List, Calendar, ChevronDown, ChevronUp, Clock, User
} from 'lucide-react';

// Asegura que las variables globales del entorno Canvas estén disponibles
const appId = typeof __app_id !== 'undefined' ? __app_id : 'project-manager-default';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Configuración de Log de Firebase para depuración
setLogLevel('Debug');

// --- Componente de Carga/Error ---
const LoadingState = ({ isLoading, error, children }) => {
  if (error) {
    return (
      <div className="p-6 text-red-700 bg-red-100 rounded-lg max-w-lg mx-auto mt-10">
        <h2 className="font-bold text-lg mb-2">Error de Configuración</h2>
        <p>No se pudo iniciar la aplicación de gestión de proyectos. {error}</p>
        <p className="text-sm mt-2">Por favor, revisa la configuración de Firebase.</p>
      </div>
    );
  }
  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-screen bg-gray-50">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600 mr-2" />
        <span className="text-lg text-gray-600">Cargando aplicación...</span>
      </div>
    );
  }
  return children;
};

// -----------------------------------------------------------------------------
// 1. HOOK: useFirebaseSetup
// -----------------------------------------------------------------------------
const useFirebaseSetup = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    let unsubscribeAuth = () => {};
    try {
      if (!firebaseConfig) {
        throw new Error("La configuración de Firebase no está disponible.");
      }
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);
      setDb(dbInstance);
      setAuth(authInstance);

      const setupAuth = async () => {
        if (initialAuthToken) {
          await signInWithCustomToken(authInstance, initialAuthToken);
        } else {
          await signInAnonymously(authInstance);
        }
      };

      unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
        if (user) {
          setUserId(user.uid);
          console.log("Firebase Auth: Usuario autenticado con UID:", user.uid);
        } else {
          setupAuth().catch(err => {
            console.error("Firebase Auth Error:", err);
            setError("Fallo en la autenticación: " + err.message);
          });
        }
        setIsLoading(false);
      });
    } catch (e) {
      console.error("Error al inicializar Firebase:", e);
      setError("Error al configurar la base de datos: " + e.message);
      setIsLoading(false);
    }
    return () => unsubscribeAuth();
  }, []);

  return { db, auth, userId, isLoading, error };
};

// -----------------------------------------------------------------------------
// 2. HOOK: useProjectManager
// -----------------------------------------------------------------------------
const useProjectManager = (db, userId) => {
  const [projects, setProjects] = useState([]);
  const [loadingData, setLoadingData] = useState(true);
  const [dataError, setDataError] = useState(null);

  // Definimos la ruta de la colección
  const getCollectionPath = useCallback((collectionName) => {
    // Ruta pública para colaboración entre usuarios
    return `artifacts/${appId}/public/data/${collectionName}`;
  }, []);

  const projectsColRef = useMemo(() => {
    if (!db) return null;
    return collection(db, getCollectionPath('projects'));
  }, [db, getCollectionPath]);

  // Escuchar los cambios en la colección de proyectos
  useEffect(() => {
    if (!projectsColRef || !userId) return;

    setLoadingData(true);
    const q = query(projectsColRef);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const projectsList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Convertir Timestamp a Date para manejo en React
        createdAt: doc.data().createdAt?.toDate() || new Date()
      })).sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

      setProjects(projectsList);
      setLoadingData(false);
      setDataError(null);
      console.log("Datos de proyectos actualizados.");
    }, (error) => {
      console.error("Error fetching projects:", error);
      setDataError("Fallo al cargar datos: " + error.message);
      setLoadingData(false);
    });

    return () => unsubscribe();
  }, [projectsColRef, userId]);

  // CRUD Operations
  const addProject = async (name) => {
    if (!projectsColRef) return;
    try {
      await addDoc(projectsColRef, {
        name: name,
        taskCount: 0,
        completedTasks: 0,
        createdAt: new Date(),
        ownerId: userId,
      });
    } catch (e) {
      console.error("Error adding project: ", e);
      setDataError("No se pudo añadir el proyecto.");
    }
  };

  const updateProjectName = async (id, newName) => {
    if (!projectsColRef) return;
    try {
      const projectRef = doc(projectsColRef, id);
      await updateDoc(projectRef, { name: newName });
    } catch (e) {
      console.error("Error updating project name: ", e);
      setDataError("No se pudo actualizar el nombre del proyecto.");
    }
  };

  const deleteProject = async (id) => {
    if (!projectsColRef || !db) return;
    try {
      // 1. Eliminar todas las tareas asociadas.
      const tasksColRef = collection(db, getCollectionPath('tasks'));
      const tasksQuery = query(tasksColRef, where("projectId", "==", id));
      const tasksSnapshot = await getDocs(tasksQuery);

      // Usar Promise.all para concurrencia (mejor que el bucle 'for of' secuencial)
      const deletePromises = tasksSnapshot.docs.map(d => deleteDoc(d.ref));
      await Promise.all(deletePromises);

      // 2. Eliminar el documento del proyecto
      await deleteDoc(doc(projectsColRef, id));
    } catch (e) {
      console.error("Error deleting project: ", e);
      setDataError("No se pudo eliminar el proyecto ni sus tareas asociadas.");
    }
  };

  return { projects, loadingData, dataError, addProject, updateProjectName, deleteProject, getCollectionPath, projectsColRef };
};

// -----------------------------------------------------------------------------
// 3. HOOK: useTasks
// -----------------------------------------------------------------------------
const useTasks = (db, projectId, projectManager, userId) => {
  const [tasks, setTasks] = useState([]);
  const [loadingTasks, setLoadingTasks] = useState(false);

  const tasksColRef = useMemo(() => {
    if (!db) return null;
    return collection(db, projectManager.getCollectionPath('tasks'));
  }, [db, projectManager]);

  // Escuchar cambios en las tareas del proyecto seleccionado
  useEffect(() => {
    if (!tasksColRef || !projectId || !userId) return;

    setLoadingTasks(true);
    const q = query(tasksColRef, where("projectId", "==", projectId));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const tasksList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Manejar Timestamps si existen
        timerStartedAt: doc.data().timerStartedAt?.toDate ? doc.data().timerStartedAt.toDate() : doc.data().timerStartedAt
      })).sort((a, b) => (a.order || 0) - (b.order || 0)); // Ordenar por campo 'order'

      setTasks(tasksList);
      setLoadingTasks(false);

      // Actualizar el contador de tareas en el proyecto (denormalización)
      const completed = tasksList.filter(t => t.isCompleted).length;
      const total = tasksList.length;

      if (projectManager.projectsColRef && projectManager.projects.find(p => p.id === projectId)) {
        const projectRef = doc(projectManager.projectsColRef, projectId);
        // Usamos setDoc con merge: true para no sobrescribir todo el documento del proyecto
        updateDoc(projectRef, { taskCount: total, completedTasks: completed }).catch(e => console.error("Error updating task counts:", e));
      }
    }, (error) => {
      console.error("Error fetching tasks:", error);
      setLoadingTasks(false);
    });

    return () => unsubscribe();
  }, [tasksColRef, projectId, userId, projectManager]);

  // CRUD de Tareas
  const addTask = async (description) => {
    if (!tasksColRef || !projectId) return;
    try {
      const newOrder = tasks.length > 0 ? Math.max(...tasks.map(t => t.order || 0)) + 1 : 1;
      await addDoc(tasksColRef, {
        projectId: projectId,
        description: description,
        isCompleted: false,
        order: newOrder,
        createdAt: new Date(),
        timerStartedAt: null,
        totalTimeSpent: 0,
        ownerId: userId,
      });
    } catch (e) {
      console.error("Error adding task: ", e);
    }
  };

  const updateTask = async (id, updates) => {
    if (!tasksColRef) return;
    try {
      const taskRef = doc(tasksColRef, id);
      await updateDoc(taskRef, updates);
    } catch (e) {
      console.error("Error updating task: ", e);
    }
  };

  const deleteTask = async (id) => {
    if (!tasksColRef) return;
    try {
      const taskRef = doc(tasksColRef, id);
      await deleteDoc(taskRef);
    } catch (e) {
      console.error("Error deleting task: ", e);
    }
  };

  // Funciones de Pomodoro/Temporizador
  const startTimer = async (taskId) => {
    // Detener cualquier otro temporizador activo antes de iniciar uno nuevo (buena práctica)
    const activeTask = tasks.find(t => t.timerStartedAt);
    if (activeTask && activeTask.id !== taskId) {
      await stopTimer(activeTask.id);
    }
    await updateTask(taskId, { timerStartedAt: new Date() });
  };

  const stopTimer = async (taskId) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task || !task.timerStartedAt) return;

    // Aseguramos que es un objeto Date
    const startTime = task.timerStartedAt instanceof Date ? task.timerStartedAt : task.timerStartedAt;
    const timeSpent = new Date().getTime() - startTime.getTime(); // tiempo en ms

    await updateTask(taskId, {
      timerStartedAt: null,
      totalTimeSpent: (task.totalTimeSpent || 0) + Math.round(timeSpent / 1000) // Guardar en segundos
    });
  };

  // REORDENAMIENTO CORREGIDO: Usando una Transacción (Atómico)
  const reorderTask = async (taskId, direction) => {
    if (!db || !tasksColRef) return;

    const currentIndex = tasks.findIndex(t => t.id === taskId);
    if (currentIndex === -1) return;

    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (newIndex < 0 || newIndex >= tasks.length) return;

    const currentTask = tasks[currentIndex];
    const targetTask = tasks[newIndex];

    try {
      // 1. Ejecutar una transacción para garantizar la atomicidad
      await runTransaction(db, async (transaction) => {
        const currentTaskRef = doc(tasksColRef, currentTask.id);
        const targetTaskRef = doc(tasksColRef, targetTask.id);

        // 2. Intercambiar los valores del campo 'order' de forma segura
        transaction.update(currentTaskRef, { order: targetTask.order });
        transaction.update(targetTaskRef, { order: currentTask.order });
      });
      console.log(`Reordenamiento de tarea ${currentTask.id} con ${targetTask.id} completado de forma atómica.`);
    } catch (e) {
      console.error("Error reordering task with transaction:", e);
    }
  };

  return { tasks, loadingTasks, addTask, updateTask, deleteTask, startTimer, stopTimer, reorderTask };
};

// -----------------------------------------------------------------------------
// 4. COMPONENTES UI
// -----------------------------------------------------------------------------

// Formato de tiempo (segundos a HH:MM:SS)
const formatTime = (totalSeconds) => {
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');
};

const ProjectItem = ({ project, onSelect, onDelete, onEdit }) => {
  const progress = project.taskCount > 0 ? Math.round((project.completedTasks / project.taskCount) * 100) : 0;

  return (
    <div className="bg-white p-4 rounded-xl shadow-md flex flex-col justify-between hover:shadow-lg transition duration-200">
      <div className="flex justify-between items-start mb-2">
        <h3 className="text-xl font-semibold text-gray-800 break-words">{project.name}</h3>
        <div className="flex space-x-2">
          <button onClick={() => onEdit(project)} className="text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-50 transition">
            <PencilIcon className="w-5 h-5" />
          </button>
          <button onClick={() => onDelete(project.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition">
            <TrashIcon className="w-5 h-5" />
          </button>
        </div>
      </div>

      <div className="text-sm text-gray-500 mb-3">
        <span className="font-medium">{project.completedTasks}</span> de <span className="font-medium">{project.taskCount}</span> tareas completadas
      </div>

      <div className="w-full bg-gray-200 rounded-full h-2.5 mb-4">
        <div className="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
      </div>

      <button
        onClick={() => onSelect(project.id)}
        className="mt-auto w-full flex items-center justify-center bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150 font-medium"
      >
        <List className="w-5 h-5 mr-2" />
        Ver Tareas ({progress}%)
      </button>
    </div>
  );
};

const TaskItem = ({ task, updateTask, deleteTask, startTimer, stopTimer, reorderTask, totalTasks }) => {
  const [descriptionEdit, setDescriptionEdit] = useState(task.description);
  const [isEditing, setIsEditing] = useState(false);
  const [currentDuration, setCurrentDuration] = useState(0);

  // Efecto para el temporizador en tiempo real
  useEffect(() => {
    let interval = null;
    if (task.timerStartedAt) {
      interval = setInterval(() => {
        const elapsed = Math.floor((new Date().getTime() - task.timerStartedAt.getTime()) / 1000);
        setCurrentDuration(elapsed);
      }, 1000);
    } else {
      setCurrentDuration(0);
    }
    return () => clearInterval(interval);
  }, [task.timerStartedAt]);

  const handleEditSave = () => {
    if (descriptionEdit.trim() !== task.description) {
      updateTask(task.id, { description: descriptionEdit.trim() });
    }
    setIsEditing(false);
  };

  const timeDisplay = task.timerStartedAt
    ? formatTime(task.totalTimeSpent + currentDuration)
    : formatTime(task.totalTimeSpent);

  return (
    <div className={`flex items-center p-3 mb-2 rounded-lg transition duration-200 ${task.isCompleted ? 'bg-green-50 shadow-inner opacity-70' : 'bg-white shadow'}`}>
      <button
        onClick={() => updateTask(task.id, { isCompleted: !task.isCompleted })}
        className={`p-1 mr-3 rounded-full transition ${task.isCompleted ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-gray-600'}`}
      >
        <CheckCircleIcon className="w-6 h-6" fill={task.isCompleted ? 'currentColor' : 'none'} stroke={task.isCompleted ? 'white' : 'currentColor'} />
      </button>

      <div className="flex-1 min-w-0">
        {isEditing ? (
          <input
            value={descriptionEdit}
            onChange={(e) => setDescriptionEdit(e.target.value)}
            onBlur={handleEditSave}
            onKeyDown={(e) => { if (e.key === 'Enter') handleEditSave(); }}
            autoFocus
            className="w-full text-base font-medium border-b border-indigo-300 focus:outline-none bg-transparent"
          />
        ) : (
          <p
            className={`text-base font-medium text-gray-800 truncate cursor-pointer ${task.isCompleted ? 'line-through text-gray-500' : ''}`}
            onClick={() => setIsEditing(true)}
          >
            {task.description}
          </p>
        )}
        <div className="flex items-center text-sm text-gray-500 mt-0.5">
          <Clock className="w-4 h-4 mr-1" />
          <span>Tiempo total: {timeDisplay}</span>
        </div>
      </div>

      <div className="flex items-center space-x-1.5 ml-4">
        {/* Botones de control del temporizador */}
        <button
          onClick={() => task.timerStartedAt ? stopTimer(task.id) : startTimer(task.id)}
          className={`p-1.5 rounded-full transition ${task.timerStartedAt ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-indigo-100 hover:bg-indigo-200 text-indigo-600'}`}
          title={task.timerStartedAt ? "Detener Temporizador" : "Iniciar Temporizador"}
        >
          {task.timerStartedAt ? <Square className="w-5 h-5 fill-white" /> : <PlayIcon className="w-5 h-5 fill-indigo-600" />}
        </button>

        {/* Botones de Reordenamiento */}
        <div className="flex flex-col space-y-0.5">
          <button
            onClick={() => reorderTask(task.id, 'up')}
            disabled={task.order === tasks[0].order}
            className={`p-0.5 rounded transition ${task.order === tasks[0].order ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-200 hover:text-gray-700'}`}
          >
            <ChevronUp className="w-4 h-4" />
          </button>
          <button
            onClick={() => reorderTask(task.id, 'down')}
            disabled={task.order === tasks[totalTasks - 1].order}
            className={`p-0.5 rounded transition ${task.order === tasks[totalTasks - 1].order ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-200 hover:text-gray-700'}`}
          >
            <ChevronDown className="w-4 h-4" />
          </button>
        </div>

        {/* Botón de Eliminar */}
        <button
          onClick={() => deleteTask(task.id)}
          className="text-red-500 hover:bg-red-100 p-1.5 rounded-full transition"
        >
          <TrashIcon className="w-5 h-5" />
        </button>
      </div>
    </div>
  );
};

// -----------------------------------------------------------------------------
// 5. COMPONENTE PRINCIPAL (App)
// -----------------------------------------------------------------------------

const App = () => {
  const { db, userId, isLoading, error } = useFirebaseSetup();
  const projectManager = useProjectManager(db, userId);
  const { projects, loadingData, dataError, addProject, deleteProject, updateProjectName } = projectManager;

  const [selectedProjectId, setSelectedProjectId] = useState(null);
  const [newProjectName, setNewProjectName] = useState('');
  const [editingProject, setEditingProject] = useState(null);

  // Determinar el proyecto seleccionado
  const selectedProject = useMemo(() => {
    return projects.find(p => p.id === selectedProjectId);
  }, [projects, selectedProjectId]);

  // Hook de tareas para el proyecto activo
  const { tasks, loadingTasks, addTask, updateTask, deleteTask, startTimer, stopTimer, reorderTask } = useTasks(db, selectedProjectId, projectManager, userId);

  const handleAddProject = () => {
    if (newProjectName.trim()) {
      addProject(newProjectName.trim());
      setNewProjectName('');
    }
  };

  const handleEditProject = (name) => {
    if (editingProject && name.trim()) {
      updateProjectName(editingProject.id, name.trim());
      setEditingProject(null);
    }
  };

  return (
    <LoadingState isLoading={isLoading} error={error}>
      <div className="min-h-screen bg-gray-50 font-[Inter]">
        <header className="bg-white shadow-sm p-4 sticky top-0 z-10 border-b border-indigo-100">
          <div className="max-w-7xl mx-auto flex justify-between items-center">
            <h1 className="text-2xl font-bold text-indigo-700 flex items-center">
              <List className="w-6 h-6 mr-2" />
              Gestor de Proyectos (v2)
            </h1>
            <div className="text-sm text-gray-500 flex items-center">
              <User className="w-4 h-4 mr-1"/>
              UID: <span className="font-mono text-xs ml-1 bg-gray-100 p-1 rounded break-all">{userId || 'Cargando...'}</span>
            </div>
          </div>
        </header>

        <main className="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Columna de Proyectos */}
          <div className="lg:col-span-1">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Mis Proyectos</h2>

            {/* Formulario de Nuevo Proyecto / Edición */}
            <div className="mb-6 p-4 bg-indigo-50 rounded-xl shadow-inner">
              <input
                type="text"
                placeholder={editingProject ? `Editando: ${editingProject.name}` : "Nombre del nuevo proyecto..."}
                value={editingProject ? editingProject.name : newProjectName}
                onChange={(e) => editingProject ? setEditingProject({ ...editingProject, name: e.target.value }) : setNewProjectName(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    if (editingProject) {
                      handleEditProject(editingProject.name);
                    } else {
                      handleAddProject();
                    }
                  }
                }}
                className="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3"
              />
              <button
                onClick={() => editingProject ? handleEditProject(editingProject.name) : handleAddProject()}
                disabled={editingProject ? !editingProject.name.trim() : !newProjectName.trim()}
                className="w-full flex items-center justify-center bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50"
              >
                {editingProject ? (
                  <>
                    <PencilIcon className="w-5 h-5 mr-2" />
                    Guardar Edición
                  </>
                ) : (
                  <>
                    <PlusIcon className="w-5 h-5 mr-2" />
                    Añadir Proyecto
                  </>
                )}
              </button>
              {editingProject && (
                  <button
                      onClick={() => setEditingProject(null)}
                      className="w-full mt-2 flex items-center justify-center bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-150"
                  >
                      Cancelar
                  </button>
              )}
            </div>

            {loadingData && (
              <div className="flex justify-center p-8 text-indigo-600">
                <Loader2 className="w-6 h-6 animate-spin mr-2" />
                Cargando proyectos...
              </div>
            )}
            {dataError && <p className="text-red-500 p-4 bg-red-100 rounded-lg">{dataError}</p>}

            <div className="space-y-4">
              {projects.map(project => (
                <ProjectItem
                  key={project.id}
                  project={project}
                  onSelect={setSelectedProjectId}
                  onDelete={deleteProject}
                  onEdit={setEditingProject}
                />
              ))}
            </div>
            {!loadingData && projects.length === 0 && (
                <div className="text-center p-8 bg-white rounded-xl shadow-md text-gray-500">
                    <Calendar className="w-8 h-8 mx-auto mb-2"/>
                    Aún no hay proyectos. ¡Crea el primero!
                </div>
            )}
          </div>

          {/* Columna de Tareas */}
          <div className="lg:col-span-2">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">
              Tareas: {selectedProject ? selectedProject.name : 'Selecciona un Proyecto'}
            </h2>

            {selectedProjectId ? (
              <>
                {/* Formulario de Nueva Tarea */}
                <div className="mb-6 p-4 bg-white rounded-xl shadow">
                  <input
                    type="text"
                    id="newTask"
                    placeholder="Descripción de la nueva tarea..."
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && e.target.value.trim()) {
                        addTask(e.target.value.trim());
                        e.target.value = '';
                      }
                    }}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </div>

                {loadingTasks && (
                  <div className="flex justify-center p-8 text-indigo-600">
                    <Loader2 className="w-6 h-6 animate-spin mr-2" />
                    Cargando tareas...
                  </div>
                )}

                <div className="space-y-3">
                  {tasks.map(task => (
                    <TaskItem
                      key={task.id}
                      task={task}
                      updateTask={updateTask}
                      deleteTask={deleteTask}
                      startTimer={startTimer}
                      stopTimer={stopTimer}
                      reorderTask={reorderTask}
                      totalTasks={tasks.length}
                    />
                  ))}
                  {!loadingTasks && tasks.length === 0 && (
                    <div className="text-center p-8 bg-white rounded-xl shadow-md text-gray-500 mt-4">
                        <List className="w-8 h-8 mx-auto mb-2"/>
                        ¡Este proyecto está limpio! Añade tu primera tarea arriba.
                    </div>
                  )}
                </div>
              </>
            ) : (
              <div className="text-center p-20 bg-white rounded-xl shadow-lg text-gray-500">
                <List className="w-12 h-12 mx-auto mb-4 text-indigo-400"/>
                <p className="text-lg">Selecciona un proyecto a la izquierda para ver y gestionar sus tareas.</p>
              </div>
            )}
          </div>
        </main>
      </div>
    </LoadingState>
  );
};

export default App;
