<?php
/**
 * HANDLERS DE AJAX PARA EL GESTOR DE PROYECTOS REMOTO
 * Estas funciones se comunican con el JavaScript de la aplicación.
 */

// 1. Manejador para Cargar los datos (pm_load_data)
// Este hook responde a la acción 'pm_load_data' enviada desde JS (loadProjects)
add_action('wp_ajax_pm_load_data', 'pm_handle_load_data');
// También permite acceso a usuarios no logueados (opcional, pero no recomendado para datos internos)
// add_action('wp_ajax_nopriv_pm_load_data', 'pm_handle_load_data'); 
function pm_handle_load_data() {
    // === SEGURIDAD BÁSICA: Solo permitir a usuarios logueados ===
    if (!is_user_logged_in()) {
        wp_send_json_error('No autorizado. Debes iniciar sesión en WordPress.');
        wp_die();
    }

    // Obtener los datos almacenados bajo la opción 'project_manager_data'
    // El '[]' es el valor por defecto si no existe la opción (primer uso)
    $stored_data = get_option('project_manager_data', '[]');
    
    // Devolver una respuesta JSON con éxito y los datos (string JSON)
    wp_send_json_success($stored_data);
    
    wp_die(); // Siempre terminar con wp_die() en AJAX handlers
}


// 2. Manejador para Guardar los datos (pm_save_data)
// Este hook responde a la acción 'pm_save_data' enviada desde JS (saveProjects)
add_action('wp_ajax_pm_save_data', 'pm_handle_save_data');
// add_action('wp_ajax_nopriv_pm_save_data', 'pm_handle_save_data'); // No recomendado
function pm_handle_save_data() {
    // === SEGURIDAD BÁSICA: Solo permitir a usuarios logueados ===
    if (!is_user_logged_in()) {
        wp_send_json_error('No autorizado. Debes iniciar sesión en WordPress.');
        wp_die();
    }
    
    // Verificar si se enviaron los datos 'projects_data' en la petición POST
    if (isset($_POST['projects_data'])) {
        // Sanitizar el string JSON antes de guardarlo. 
        // Se usa wp_unslash() para eliminar barras si se han añadido automáticamente.
        $projects_data_json = sanitize_textarea_field(wp_unslash($_POST['projects_data']));
        
        // Guardar el string JSON completo en la base de datos de WordPress
        // 'yes' indica que se cargue automáticamente si es necesario (opcional)
        $success = update_option('project_manager_data', $projects_data_json, 'yes');
        
        if ($success) {
            wp_send_json_success('Datos guardados exitosamente.');
        } else {
            // Esto es común si los datos no cambiaron. No es necesariamente un error grave.
            wp_send_json_error('Fallo al actualizar o no hubo cambios en la base de datos.');
        }
    } else {
        wp_send_json_error('Datos de proyecto no recibidos.');
    }

    wp_die();
}
