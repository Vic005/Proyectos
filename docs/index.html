<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Conexión Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .status-box { padding: 1rem; border-radius: 0.75rem; margin-top: 1rem; }
        .status-success { background-color: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-info { background-color: #e0f2fe; color: #0369a1; border: 1px solid #38bdf8; }
        .step-inactive { opacity: 0.5; }
        .step-active { opacity: 1; font-weight: 600; }
        .step-success::before { content: "✅"; margin-right: 0.5rem; }
        .step-fail::before { content: "❌"; margin-right: 0.5rem; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-2xl rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">
            Diagnóstico de Conexión Firebase (v2)
        </h1>
        <p class="text-gray-600 mb-6">
            Esta herramienta revisa la disponibilidad de las variables de entorno de Firebase y el proceso de autenticación.
        </p>

        <!-- Global Status Box -->
        <div id="global-status" class="status-box status-info">
            <h2 class="text-xl font-bold mb-2">Estado de Conexión (FIREBASE)</h2>
            <p id="status-message">Iniciando diagnóstico...</p>
        </div>

        <!-- Diagnostic Steps -->
        <div class="mt-8 space-y-3">
            <div id="step-1" class="step-inactive text-lg">Paso 1: Verificando variables de entorno.</div>
            <div id="step-2" class="step-inactive text-lg">Paso 2: Inicializando Firebase y Firestore.</div>
            <div id="step-3" class="step-inactive text-lg">Paso 3: Intentando autenticación con token inicial.</div>
            <div id="step-4" class="step-inactive text-lg">Paso 4: Conexión Exitosa. Lista para usar.</div>
        </div>

        <!-- Debug Log -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-2">Log de Depuración</h2>
            <pre id="debug-log" class="bg-gray-100 p-4 text-sm rounded-lg overflow-x-auto h-48"></pre>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Importación de módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables de UI
        const globalStatusEl = document.getElementById('global-status');
        const statusMessageEl = document.getElementById('status-message');
        const debugLogEl = document.getElementById('debug-log');
        const steps = [null, document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3'), document.getElementById('step-4')];

        // Configuración de Log de Firebase
        setLogLevel('Debug');

        /**
         * Registra un mensaje en el log de depuración y en la consola.
         * @param {string} message Mensaje a registrar.
         */
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            debugLogEl.textContent += logEntry;
            console.log(`[FIREBASE DIAG] ${message}`);
        }

        /**
         * Actualiza el estado global de la aplicación.
         * @param {number} step El paso actual (1 a 4).
         * @param {string} message El mensaje a mostrar.
         * @param {string} type El tipo de estado ('info', 'success', 'error').
         */
        function updateStatus(step, message, type = 'info') {
            logDebug(`Estado Actualizado: Paso ${step} - ${message} (${type})`);

            // Limpiar clases de estado global
            globalStatusEl.classList.remove('status-info', 'status-success', 'status-error');

            // Aplicar la nueva clase de estado global
            switch (type) {
                case 'success':
                    globalStatusEl.classList.add('status-success');
                    break;
                case 'error':
                    globalStatusEl.classList.add('status-error');
                    break;
                default:
                    globalStatusEl.classList.add('status-info');
                    break;
            }

            statusMessageEl.textContent = message;

            // Actualizar pasos
            steps.forEach((el, index) => {
                if (el) {
                    el.classList.remove('step-active', 'step-inactive', 'step-success', 'step-fail');
                    if (index < step) {
                        el.classList.add('step-success'); // Pasos completados con éxito
                    } else if (index === step) {
                        el.classList.add('step-active');
                    } else {
                        el.classList.add('step-inactive');
                    }
                }
            });

            // Si falla, marca el paso actual como fallido
            if (type === 'error' && step > 0 && steps[step]) {
                steps[step].classList.add('step-fail');
            }
        }


        /**
         * Función principal para configurar e inicializar Firebase.
         */
        async function setupFirebase() {
            let app, db, auth;
            let userId = null;

            try {
                updateStatus(1, 'Verificando variables de entorno...');

                // ----------------------------------------------------
                // Paso 1: Verificación de Variables Críticas
                // ----------------------------------------------------
                const appId = typeof __app_id !== 'undefined' ? __app_id : null;
                const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!appId) {
                    throw new Error("La variable global '__app_id' no está definida.");
                }
                if (!firebaseConfigString) {
                    throw new Error("La variable global '__firebase_config' no está definida.");
                }

                let firebaseConfig;
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString);
                } catch (e) {
                    throw new Error(`Fallo al parsear JSON de __firebase_config: ${e.message}`);
                }

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("El objeto firebaseConfig está vacío o le falta 'apiKey'.");
                }
                logDebug(`__app_id: ${appId}`);
                logDebug(`__firebase_config parseado con éxito.`);
                logDebug(`__initial_auth_token presente: ${!!initialAuthToken}`);

                // ----------------------------------------------------
                // Paso 2: Inicialización de Firebase
                // ----------------------------------------------------
                updateStatus(2, 'Inicializando Firebase App y Firestore...');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logDebug('Firebase App, Auth y Firestore inicializados correctamente.');


                // ----------------------------------------------------
                // Paso 3: Autenticación
                // ----------------------------------------------------
                updateStatus(3, 'Intentando autenticación con token inicial...');

                const authPromise = new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Detener el listener después del primer evento
                        if (user) {
                            userId = user.uid;
                            logDebug(`Usuario autenticado (UID: ${userId})`);
                            resolve();
                        } else {
                            // Si no hay usuario, intentar iniciar sesión con el token o de forma anónima.
                            try {
                                if (initialAuthToken) {
                                    logDebug('Intentando signInWithCustomToken...');
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    logDebug('Token no encontrado. Intentando signInAnonymously...');
                                    await signInAnonymously(auth);
                                }
                                // Esperar al siguiente onAuthStateChanged para obtener el user.uid
                                onAuthStateChanged(auth, (newUser) => {
                                    if (newUser) {
                                        userId = newUser.uid;
                                        logDebug(`Autenticación completada. UID: ${userId}`);
                                        resolve();
                                    } else {
                                        reject(new Error("La autenticación falló, no se pudo obtener el UID."));
                                    }
                                });
                            } catch (error) {
                                reject(new Error(`Fallo en la autenticación (Token/Anónimo): ${error.message}`));
                            }
                        }
                    });
                });

                await authPromise;


                // ----------------------------------------------------
                // Paso 4: Finalizado
                // ----------------------------------------------------
                updateStatus(4, `Conexión Exitosa. Su ID de usuario (UID) es: ${userId}.`, 'success');

            } catch (error) {
                // Manejo de cualquier error crítico
                console.error("FIREBASE ERROR CRÍTICO:", error);
                const step = parseInt(error.message.match(/Paso (\d)/)?.[1] || 0) || 1; // Intenta adivinar el paso del error

                updateStatus(step, `ERROR CRÍTICO: ${error.message}`, 'error');
                logDebug(`FALLO FINAL: ${error.message}`);
                // Si la configuración de Firebase falla, no podemos hacer más.
            }
        }

        // Ejecutar el setup de forma inmediata
        setupFirebase();

    </script>
</body>
</html>
