import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import {
    getFirestore, collection, query, where, onSnapshot,
    addDoc, updateDoc, deleteDoc, doc, setLogLevel, getDocs
} from 'firebase/firestore';
import {
    PencilIcon, TrashIcon, CheckCircleIcon, PlayIcon, Square, // <<-- CORREGIDO: Stop cambiado a Square
    PlusIcon, Loader2, List, Calendar, ChevronDown, ChevronUp
} from 'lucide-react';

// -----------------------------------------------------------------------------
// 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
// -----------------------------------------------------------------------------

// Configuración de Log de Firebase para depuración
setLogLevel('Debug');

const useFirebaseSetup = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        let unsubscribeAuth = () => {};

        try {
            // Usamos un valor por defecto si __app_id no está disponible
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'project-manager-default';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (!firebaseConfigString) {
                throw new Error("La configuración de Firebase no está disponible.");
            }

            const firebaseConfig = JSON.parse(firebaseConfigString);
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);

            setDb(dbInstance);
            setAuth(authInstance);

            const setupAuth = async () => {
                // Autenticar con token si está disponible, sino, de forma anónima
                if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                } else {
                    await signInAnonymously(authInstance);
                }
            };

            unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                    setUserId(user.uid);
                    console.log("Firebase Auth: Usuario autenticado con UID:", user.uid);
                } else {
                    // Si el usuario no está autenticado, intentar el proceso de inicio de sesión
                    setupAuth().catch(err => {
                        console.error("Firebase Auth Error:", err);
                        setError("Fallo en la autenticación: " + err.message);
                        setIsLoading(false);
                    });
                }
                // Marcar como cargado una vez que se complete la primera verificación
                setIsLoading(false);
            });

        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            setError("Error al configurar la base de datos: " + e.message);
            setIsLoading(false);
        }

        return () => unsubscribeAuth();
    }, []);

    return { db, auth, userId, isLoading, error };
};

// -----------------------------------------------------------------------------
// 2. HOOK PARA LA GESTIÓN DE DATOS (FIREBASE FIRESTORE)
// -----------------------------------------------------------------------------

const useProjectManager = (db, userId) => {
    const [projects, setProjects] = useState([]);
    const [loadingData, setLoadingData] = useState(true);
    const [dataError, setDataError] = useState(null);

    // Definimos la ruta de la colección
    const getCollectionPath = (collectionName) => {
        // Usamos una ruta pública para que los proyectos sean visibles para todos si hay más usuarios.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'project-manager-default';
        return `artifacts/${appId}/public/data/${collectionName}`;
    };

    const projectsColRef = useMemo(() => {
        if (!db) return null;
        return collection(db, getCollectionPath('projects'));
    }, [db]);

    // Escuchar los cambios en la colección de proyectos
    useEffect(() => {
        if (!projectsColRef || !userId) return;

        setLoadingData(true);
        const q = query(projectsColRef); // Obtener todos los proyectos
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const projectsList = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                createdAt: doc.data().createdAt?.toDate() || new Date()
            })).sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime()); // Ordenar por fecha de creación descendente

            setProjects(projectsList);
            setLoadingData(false);
            setDataError(null);
            console.log("Datos de proyectos actualizados.");
        }, (error) => {
            console.error("Error fetching projects:", error);
            setDataError("Fallo al cargar datos: " + error.message);
            setLoadingData(false);
        });

        return () => unsubscribe();
    }, [projectsColRef, userId]);

    // CRUD Operations

    const addProject = async (name) => {
        if (!projectsColRef) return;
        try {
            await addDoc(projectsColRef, {
                name: name,
                taskCount: 0,
                completedTasks: 0,
                createdAt: new Date(),
                ownerId: userId,
            });
        } catch (e) {
            console.error("Error adding project: ", e);
            setDataError("No se pudo añadir el proyecto.");
        }
    };

    const updateProjectName = async (id, newName) => {
        if (!projectsColRef) return;
        try {
            const projectRef = doc(projectsColRef, id);
            await updateDoc(projectRef, { name: newName });
        } catch (e) {
            console.error("Error updating project name: ", e);
            setDataError("No se pudo actualizar el nombre del proyecto.");
        }
    };

    // ELIMINACIÓN DE PROYECTO (Corregido: se eliminó el 'catch' duplicado y la lógica de batch
    // que requería una importación no disponible. Ahora usa eliminación individual con getDocs).
    const deleteProject = async (id) => {
        if (!projectsColRef) return;
        try {
            // Eliminar primero todas las tareas asociadas.
            const tasksColRef = collection(db, getCollectionPath('tasks'));
            const tasksQuery = query(tasksColRef, where("projectId", "==", id));
            
            // Obtener todas las tareas asociadas al proyecto
            const tasksSnapshot = await getDocs(tasksQuery); 
            
            // Eliminación de tareas individuales
            for (const d of tasksSnapshot.docs) {
                await deleteDoc(d.ref);
            }
            
            // Eliminar el documento del proyecto
            await deleteDoc(doc(projectsColRef, id));

        } catch (e) {
            console.error("Error deleting project: ", e);
            setDataError("No se pudo eliminar el proyecto.");
        }
    };

    return {
        projects,
        loadingData,
        dataError,
        addProject,
        updateProjectName,
        deleteProject,
        getCollectionPath,
        projectsColRef // Exportar referencia para uso en useTasks
    };
};

// -----------------------------------------------------------------------------
// 3. HOOK PARA LA GESTIÓN DE TAREAS DENTRO DE UN PROYECTO
// -----------------------------------------------------------------------------

const useTasks = (db, projectId, projectManager, userId) => {
    const [tasks, setTasks] = useState([]);
    const [loadingTasks, setLoadingTasks] = useState(false);
    const tasksColRef = useMemo(() => {
        if (!db) return null;
        return collection(db, projectManager.getCollectionPath('tasks'));
    }, [db, projectManager]);

    // Escuchar cambios en las tareas del proyecto seleccionado
    useEffect(() => {
        if (!tasksColRef || !projectId || !userId) return;

        setLoadingTasks(true);
        const q = query(tasksColRef, where("projectId", "==", projectId));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const tasksList = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
            })).sort((a, b) => (a.order || 0) - (b.order || 0)); // Ordenar por campo 'order'

            setTasks(tasksList);
            setLoadingTasks(false);

            // Actualizar el contador de tareas en el proyecto
            const completed = tasksList.filter(t => t.isCompleted).length;
            const total = tasksList.length;
            // Usamos projectManager.projectsColRef para la actualización
            if (projectManager.projectsColRef && projectManager.projects.find(p => p.id === projectId)) {
                const projectRef = doc(projectManager.projectsColRef, projectId);
                updateDoc(projectRef, {
                    taskCount: total,
                    completedTasks: completed
                }).catch(e => console.error("Error updating task counts:", e));
            }
        }, (error) => {
            console.error("Error fetching tasks:", error);
            setLoadingTasks(false);
        });

        return () => unsubscribe();
    }, [tasksColRef, projectId, userId, projectManager]);

    // CRUD de Tareas

    const addTask = async (description) => {
        if (!tasksColRef || !projectId) return;
        try {
            const newOrder = tasks.length > 0 ? Math.max(...tasks.map(t => t.order || 0)) + 1 : 1;
            await addDoc(tasksColRef, {
                projectId: projectId,
                description: description,
                isCompleted: false,
                order: newOrder,
                createdAt: new Date(),
                timerStartedAt: null,
                totalTimeSpent: 0,
                ownerId: userId,
            });
        } catch (e) {
            console.error("Error adding task: ", e);
        }
    };

    const updateTask = async (id, updates) => {
        if (!tasksColRef) return;
        try {
            const taskRef = doc(tasksColRef, id);
            await updateDoc(taskRef, updates);
        } catch (e) {
            console.error("Error updating task: ", e);
        }
    };

    const deleteTask = async (id) => {
        if (!tasksColRef) return;
        try {
            const taskRef = doc(tasksColRef, id);
            await deleteDoc(taskRef);
        } catch (e) {
            console.error("Error deleting task: ", e);
        }
    };

    // Funciones de Pomodoro/Temporizador

    const startTimer = async (taskId) => {
        await updateTask(taskId, { timerStartedAt: new Date() });
    };

    const stopTimer = async (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task || !task.timerStartedAt) return;

        const startTime = task.timerStartedAt.toDate ? task.timerStartedAt.toDate() : task.timerStartedAt;
        const timeSpent = new Date().getTime() - startTime.getTime(); // tiempo en ms

        await updateTask(taskId, {
            timerStartedAt: null,
            totalTimeSpent: (task.totalTimeSpent || 0) + Math.round(timeSpent / 1000) // Guardar en segundos
        });
    };

    // Reordenar (usando un enfoque simple de intercambio de índices)
    const reorderTask = async (taskId, direction) => {
        const currentIndex = tasks.findIndex(t => t.id === taskId);
        if (currentIndex === -1) return;

        const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
        if (newIndex < 0 || newIndex >= tasks.length) return;

        const currentTask = tasks[currentIndex];
        const targetTask = tasks[newIndex];

        // Intercambiar los valores del campo 'order'
        // Se usa la actualización individual ya que writeBatch no es una importación directa
        try {
            await updateTask(currentTask.id, { order: targetTask.order });
            await updateTask(targetTask.id, { order: currentTask.order });
        } catch (e) {
            console.error("Error reordering task:", e);
        }
    };


    return {
        tasks,
        loadingTasks,
        addTask,
        updateTask,
        deleteTask,
        startTimer,
        stopTimer,
        reorderTask
    };
};

// -----------------------------------------------------------------------------
// 4. COMPONENTES DE UI
// -----------------------------------------------------------------------------

// Formato de tiempo (segundos a HH:MM:SS)
const formatTime = (totalSeconds) => {
    if (typeof totalSeconds !== 'number' || totalSeconds < 0) return '00:00:00';
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return [h, m, s]
        .map(v => v.toString().padStart(2, '0'))
        .join(':');
};

const AddProjectForm = ({ addProject, userId }) => {
    const [name, setName] = useState('');
    const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim()) {
            addProject(name.trim());
            setName('');
        }
    };

    return (
        <form onSubmit={handleSubmit} className="flex space-x-2 p-4 bg-gray-50 rounded-lg">
            <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Nombre del nuevo proyecto..."
                className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-sky-500 focus:border-sky-500"
                disabled={!userId}
            />
            <button
                type="submit"
                className="bg-sky-600 text-white p-2 rounded-md hover:bg-sky-700 transition duration-150 flex items-center disabled:opacity-50"
                disabled={!userId || !name.trim()}
            >
                <PlusIcon className="w-5 h-5 mr-1" /> Crear
            </button>
        </form>
    );
};

const AddTaskForm = ({ addTask }) => {
    const [description, setDescription] = useState('');
    const handleSubmit = (e) => {
        e.preventDefault();
        if (description.trim()) {
            addTask(description.trim());
            setDescription('');
        }
    };

    return (
        <form onSubmit={handleSubmit} className="flex space-x-2 p-4 bg-white border-t">
            <input
                type="text"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Descripción de la nueva tarea..."
                className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
            />
            <button
                type="submit"
                className="bg-emerald-600 text-white p-2 rounded-md hover:bg-emerald-700 transition duration-150 flex items-center"
            >
                <PlusIcon className="w-5 h-5 mr-1" /> Tarea
            </button>
        </form>
    );
};

const TaskItem = ({ task, updateTask, deleteTask, startTimer, stopTimer, reorderTask, isFirst, isLast }) => {
    const isRunning = !!task.timerStartedAt;
    const [elapsedTime, setElapsedTime] = useState(task.totalTimeSpent || 0);
    const [isEditing, setIsEditing] = useState(false);
    const [newDescription, setNewDescription] = useState(task.description);

    // useEffect para el cronómetro en tiempo real
    useEffect(() => {
        let interval;
        if (isRunning) {
            const startTime = task.timerStartedAt.toDate ? task.timerStartedAt.toDate() : task.timerStartedAt;
            const initialTime = task.totalTimeSpent || 0;

            const updateTimer = () => {
                const now = new Date();
                const diffSeconds = Math.floor((now.getTime() - startTime.getTime()) / 1000);
                setElapsedTime(initialTime + diffSeconds);
            };

            interval = setInterval(updateTimer, 1000);
            updateTimer(); // Actualizar inmediatamente
        } else {
            setElapsedTime(task.totalTimeSpent || 0);
            if (interval) clearInterval(interval);
        }
        return () => {
            if (interval) clearInterval(interval);
        };
    }, [isRunning, task.timerStartedAt, task.totalTimeSpent]);

    const handleToggleComplete = () => {
        if (isRunning) stopTimer(task.id);
        updateTask(task.id, { isCompleted: !task.isCompleted });
    };

    const handleSaveEdit = () => {
        if (newDescription.trim() !== task.description) {
            updateTask(task.id, { description: newDescription.trim() });
        }
        setIsEditing(false);
    };

    const handleTimerClick = () => {
        if (task.isCompleted) return; // No permitir temporizador en tareas completadas
        if (isRunning) {
            stopTimer(task.id);
        } else {
            startTimer(task.id);
        }
    };

    const opacityClass = task.isCompleted ? 'opacity-60 line-through' : 'opacity-100';
    const timerClass = isRunning ? 'bg-amber-100 text-amber-800 animate-pulse' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
    const buttonTimerClass = isRunning ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';

    return (
        <li className={`flex items-center justify-between p-3 border-b last:border-b-0 transition duration-150 ${task.isCompleted ? 'bg-green-50' : 'bg-white'}`}>
            <div className="flex items-center space-x-3 min-w-0 flex-grow">
                <button
                    onClick={handleToggleComplete}
                    className={`p-1 rounded-full transition ${task.isCompleted ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-green-500'}`}
                    title={task.isCompleted ? "Desmarcar" : "Completar"}
                >
                    <CheckCircleIcon className={`w-6 h-6 ${task.isCompleted ? 'fill-current' : 'hover:fill-current'}`} />
                </button>

                <div className={`flex-grow min-w-0 ${opacityClass}`}>
                    {isEditing ? (
                        <input
                            type="text"
                            value={newDescription}
                            onChange={(e) => setNewDescription(e.target.value)}
                            onBlur={handleSaveEdit}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') handleSaveEdit();
                            }}
                            autoFocus
                            className="w-full p-1 border rounded"
                        />
                    ) : (
                        <span className="text-gray-800 truncate" onClick={() => setIsEditing(true)}>
                            {task.description}
                        </span>
                    )}
                </div>
            </div>

            <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                {/* Temporizador */}
                <span className={`px-2 py-1 text-xs font-mono rounded-full ${timerClass}`} title="Tiempo total dedicado">
                    {formatTime(elapsedTime)}
                </span>

                {/* Botón de Iniciar/Parar */}
                <button
                    onClick={handleTimerClick}
                    className={`p-2 text-white rounded-full transition duration-150 ${buttonTimerClass} disabled:opacity-50`}
                    title={isRunning ? "Detener temporizador" : "Iniciar temporizador"}
                    disabled={task.isCompleted}
                >
                    {isRunning ? <Square className="w-5 h-5" /> : <PlayIcon className="w-5 h-5" />} {/* <<-- CORREGIDO: Stop cambiado a Square */}
                </button>

                {/* Botones de Reordenar */}
                <div className='flex flex-col space-y-0.5'>
                    <button
                        onClick={() => reorderTask(task.id, 'up')}
                        disabled={isFirst}
                        className='text-gray-500 hover:text-sky-500 disabled:opacity-30'
                        title="Subir tarea"
                    >
                        <ChevronUp className='w-4 h-4' />
                    </button>
                    <button
                        onClick={() => reorderTask(task.id, 'down')}
                        disabled={isLast}
                        className='text-gray-500 hover:text-sky-500 disabled:opacity-30'
                        title="Bajar tarea"
                    >
                        <ChevronDown className='w-4 h-4' />
                    </button>
                </div>

                {/* Botón de Eliminar */}
                <button
                    onClick={() => deleteTask(task.id)}
                    className="p-1 text-red-500 hover:text-red-700 transition"
                    title="Eliminar tarea"
                >
                    <TrashIcon className="w-5 h-5" />
                </button>
            </div>
        </li>
    );
};

const ProjectCard = ({ project, isSelected, onSelect, updateProjectName, deleteProject }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [newName, setNewName] = useState(project.name);

    const handleSaveEdit = () => {
        if (newName.trim() !== project.name) {
            updateProjectName(project.id, newName.trim());
        }
        setIsEditing(false);
    };

    const progress = project.taskCount === 0
        ? 0
        : Math.round((project.completedTasks / project.taskCount) * 100);

    const isComplete = project.taskCount > 0 && project.completedTasks === project.taskCount;

    const cardClasses = isSelected
        ? 'ring-2 ring-sky-500 bg-sky-50 shadow-lg'
        : 'hover:bg-gray-100';

    return (
        <div
            className={`p-4 rounded-xl shadow-md cursor-pointer transition duration-150 border ${cardClasses}`}
        >
            <div onClick={() => onSelect(project.id)} className="flex flex-col">
                <div className='flex items-center justify-between'>
                    {isEditing ? (
                        <input
                            type="text"
                            value={newName}
                            onChange={(e) => setNewName(e.target.value)}
                            onBlur={handleSaveEdit}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') handleSaveEdit();
                            }}
                            autoFocus
                            className="text-lg font-semibold w-full p-1 border rounded"
                        />
                    ) : (
                        <h3 className="text-lg font-semibold text-gray-800 truncate flex-grow">
                            {project.name}
                        </h3>
                    )}
                    <div className="flex space-x-2 ml-4 flex-shrink-0">
                        <button
                            onClick={(e) => { e.stopPropagation(); setIsEditing(!isEditing); }}
                            className="p-1 text-gray-500 hover:text-sky-600 transition"
                            title="Editar nombre"
                        >
                            <PencilIcon className="w-4 h-4" />
                        </button>
                        <button
                            onClick={(e) => { e.stopPropagation(); deleteProject(project.id); }}
                            className="p-1 text-red-500 hover:text-red-700 transition"
                            title="Eliminar proyecto"
                        >
                            <TrashIcon className="w-4 h-4" />
                        </button>
                    </div>
                </div>

                <p className="text-sm text-gray-500 mt-1 flex items-center">
                    <List className="w-4 h-4 mr-1" />
                    {project.completedTasks} / {project.taskCount} Tareas
                </p>
                <p className="text-xs text-gray-400 mt-0.5 flex items-center">
                    <Calendar className="w-3 h-3 mr-1" />
                    Creado: {project.createdAt.toLocaleDateString()}
                </p>
            </div>
            
            {/* Barra de Progreso */}
            <div className="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                <div
                    className={`h-2.5 rounded-full transition-all duration-500 ${isComplete ? 'bg-green-500' : 'bg-sky-500'}`}
                    style={{ width: `${progress}%` }}
                ></div>
            </div>
        </div>
    );
};

// -----------------------------------------------------------------------------
// 5. COMPONENTE PRINCIPAL
// -----------------------------------------------------------------------------

const App = () => {
    const { db, auth, userId, isLoading: isFirebaseLoading, error: firebaseError } = useFirebaseSetup();
    const {
        projects, loadingData, dataError, addProject, updateProjectName, deleteProject, getCollectionPath, projectsColRef
    } = useProjectManager(db, userId);

    const [selectedProjectId, setSelectedProjectId] = useState(null);
    const selectedProject = useMemo(() => projects.find(p => p.id === selectedProjectId), [projects, selectedProjectId]);

    // Gestión de Tareas - Pasamos la información del manager al hook de tareas
    const effectiveProjectManagerContext = useMemo(() => ({ 
        getCollectionPath, 
        projects, 
        projectsColRef 
    }), [getCollectionPath, projects, projectsColRef]);

    const {
        tasks, loadingTasks, addTask, updateTask, deleteTask, startTimer, stopTimer, reorderTask
    } = useTasks(db, selectedProjectId, effectiveProjectManagerContext, userId);


    // Manejar la selección inicial del proyecto (el primero de la lista)
    useEffect(() => {
        if (!selectedProjectId && projects.length > 0) {
            setSelectedProjectId(projects[0].id);
        }
    }, [projects, selectedProjectId]);

    // Estados de carga y error combinados
    const globalLoading = isFirebaseLoading || loadingData;
    const globalError = firebaseError || dataError;

    if (globalError) {
        return (
            <div className="p-8 text-center bg-red-100 text-red-800 rounded-xl m-4 shadow-xl">
                <h2 className="text-2xl font-bold mb-4">¡Error Crítico!</h2>
                <p className="text-left font-mono whitespace-pre-wrap">{globalError}</p>
                <p className="mt-4">Por favor, revisa la consola para más detalles sobre el fallo de conexión.</p>
            </div>
        );
    }

    if (globalLoading) {
        return (
            <div className="flex justify-center items-center h-screen">
                <Loader2 className="w-10 h-10 animate-spin text-sky-500" />
                <span className="ml-3 text-lg text-gray-600">Cargando datos...</span>
            </div>
        );
    }


    return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <header className="mb-8">
                    <h1 className="text-4xl font-extrabold text-gray-900 flex items-center">
                        <List className="w-8 h-8 mr-3 text-sky-600" />
                        Gestor de Proyectos
                    </h1>
                    <p className="text-sm text-gray-500 mt-1">
                        Usuario ID: <span className='font-mono text-xs p-1 bg-gray-200 rounded'>{userId || 'No disponible'}</span>
                        <span className='ml-4 text-xs font-semibold text-red-500'>
                             (Usando valor por defecto si APP ID no está disponible)
                        </span>
                    </p>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Panel de Proyectos (Columna Izquierda) */}
                    <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl h-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Mis Proyectos</h2>
                        <AddProjectForm addProject={addProject} userId={userId} />

                        <div className="mt-4 space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                            {projects.length === 0 ? (
                                <p className="text-gray-500 p-4 bg-gray-100 rounded-lg">Aún no hay proyectos. ¡Crea uno!</p>
                            ) : (
                                projects.map(project => (
                                    <ProjectCard
                                        key={project.id}
                                        project={project}
                                        isSelected={project.id === selectedProjectId}
                                        onSelect={setSelectedProjectId}
                                        updateProjectName={updateProjectName}
                                        deleteProject={deleteProject}
                                    />
                                ))
                            )}
                        </div>
                    </div>

                    {/* Panel de Tareas (Columna Derecha) */}
                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-xl">
                        <div className="flex justify-between items-center border-b pb-2 mb-4">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {selectedProject ? `Tareas: ${selectedProject.name}` : 'Selecciona un Proyecto'}
                            </h2>
                            {selectedProject && (
                                <span className={`px-3 py-1 text-sm font-semibold rounded-full ${selectedProject.completedTasks === selectedProject.taskCount && selectedProject.taskCount > 0 ? 'bg-green-100 text-green-700' : 'bg-sky-100 text-sky-700'}`}>
                                    Progreso: {selectedProject.completedTasks} / {selectedProject.taskCount}
                                </span>
                            )}
                        </div>

                        {selectedProject ? (
                            <>
                                <AddTaskForm addTask={addTask} />
                                <div className="mt-4 bg-gray-100 rounded-lg shadow-inner">
                                    {loadingTasks ? (
                                        <div className="flex justify-center items-center h-32">
                                            <Loader2 className="w-6 h-6 animate-spin text-sky-500" />
                                        </div>
                                    ) : (
                                        <ul className="divide-y divide-gray-200">
                                            {tasks.length === 0 ? (
                                                <p className="text-gray-500 p-6 text-center">No hay tareas. ¡Añade la primera!</p>
                                            ) : (
                                                tasks.map((task, index) => (
                                                    <TaskItem
                                                        key={task.id}
                                                        task={task}
                                                        updateTask={updateTask}
                                                        deleteTask={deleteTask}
                                                        startTimer={startTimer}
                                                        stopTimer={stopTimer}
                                                        reorderTask={reorderTask}
                                                        isFirst={index === 0}
                                                        isLast={index === tasks.length - 1}
                                                    />
                                                ))
                                            )}
                                        </ul>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="text-center p-12 bg-gray-100 rounded-lg text-gray-500">
                                <List className="w-10 h-10 mx-auto mb-3" />
                                <p>Selecciona un proyecto de la izquierda para ver y gestionar sus tareas.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
